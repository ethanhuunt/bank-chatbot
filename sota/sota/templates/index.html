{% extends 'layout/layout.html' %}
{%load static%}
{%block content%}
<link rel="stylesheet" href="{% static 'css/index.css' %}">
<div style="width: 1500px; margin: 0 auto;">
    <div style="display: inline-flex; place-content: center;padding: 0px 74px;">
        <div id='show' style="width: 760px; height: 750px; border: 1px solid #333; margin-right: 30px;">
        </div>
        <!-- 챗봇 -->
        <div class="main_wrap">
            <div id="wrap" class="wrap">
                <div class="chatBox" id="chatbox" style="padding-bottom: 120px;">
                    <div class="header">
                        <div class="title-wrap">
                            <h1 class="title">SOTA 챗봇</h1>
                        </div>
                    </div>
                    <div class="chat-bot">
                        <div class="bot-profile">
                            <!-- 챗봇 이미지 -->
                            <div class="img" style="background-image: none;">
                                <img src="https://openclipart.org/image/800px/262355" alt="챗봇">
                            </div>
                            <!-- 챗봇 이름 -->
                            <div class="name">
                                챗봇
                            </div>
                        </div>
                        <div class="bot-talk">
                            <!-- 챗봇 말 -->
                            <div class="txt">
                                <div>안녕하세용</div>
                            </div>
                            <!-- 챗봇 말한시간 -->
                            <div class="time">
                                <div>오후5:10</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="chatfooter">
                <table>
                    <tr>
                        <td width="90%" style="display: table-cell;vertical-align: middle;width: auto;padding: 9px 8px 9px 13pt;position: relative;">
                            <input id="chattext" placeholder="챗봇에게 물어보세요" style="background-color: rgb(243, 244, 246);border: 0px;height: 50px;">
                        </td>
                        <td width="10%">
                            <button id="sendbtn">SEND</button>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    // document.getElementById('footer').hide()
 
$(document).ready(function(){    
    document.getElementById('footer').style.display='none'
});
    $(function(){

// SEND 버튼을 누르거나
$("#sendbtn").click(function(){
    send_message();
});

// ENTER key 가 눌리면
$("#chattext").keyup(function(event){
    if(event.keyCode == 13){
        send_message();
    }
});

});

function send_message(){
const chattext = $("#chattext").val().trim();
const show=$("#show")
// 입력한 메세지가 없으면 리턴
if(chattext == ""){
    $("#chattext").focus();
    return;
}

// 입력한 채팅 출력

addtext = "<div class=customer><div class=customer-wrap><div class=txt><div>"+chattext+"</div></div><div class=time><div>오후5:15</div></div></div></div>";
$("#chatbox").append(addtext);    

// API 서버에 보낼 데이터 준비
const jsonData = {
    query: chattext,
    bottype: "WebClient",
};
console.log(jsonData)
$.ajax({
    url: 'http://127.0.0.1:5000/TEST',
    type: "POST",
    data: JSON.stringify(jsonData),
    dataType: "JSON",  // 응답받을 데이터 타입
    contentType: "application/json; charset=utf-8",  
    crossDomain: true,
    success: function(response){
        console.log(response)
        // response.Answer 에 챗봇의 응답메세지가 담겨 있다
        $chatbox = $("#chatbox");
        // 답변 출력

        bottext ="<div class=chat-bot><div class=bot-profile><div class=img style=background-image:none;><img src=https://openclipart.org/image/800px/262355 alt=챗봇></div><div class=name>챗봇</div></div><div class=bot-talk><div class=txt><div>"+response.Answer+"</div></div><div class=time><div>오후5:10</div></div></div></div>";
        $chatbox.append(bottext);
        if(response.Intent=='인사'){
            $show=$("#show")
            $show.append(response.Intent)
            bottext = "<div style='margin:2% 0%;text-align:left;'><span style='padding:1% 2%;background-color:#ddd;border-radius:10px;color:#424242;display:inline-block'><b>" + "<br>질문 의도를 선택해주세요" + "</b></span></div>";
                $chatbox.append(bottext)
                intent_list=['계좌조회','상품조회','이체','상환및납부','분실신고']
                button_str = "<div id='buttons'>"
                let i = 0
                for(inte of intent_list){
                    button_str += `<button class='button small primary' id=${i} style='margin: 3px;' onclick=' "${chattext}"'>${inte}</button>`
                    i += 1;
                }
                button_str += "</div>"
                $chatbox.append(button_str)
                $("#0").click(function(){
                    const jsonData = {
                        query: '카드',
                        bottype: "WebClient",
                    };
                    $.ajax({
                        
                            // url: 'http://127.0.0.1:8000/service/lookup',
                            // type:"GET",
                            // cache: false,
                            // success: function(data,status){
                            //     if(status == 'success') 
                            //     data.parseXML
                            // }
                           
                                url: 'http://127.0.0.1:5000/chatbot/TEST',
                                type: "POST",
                                data: JSON.stringify(jsonData),
                                dataType: "JSON",  // 응답받을 데이터 타입
                                contentType: "application/json; charset=utf-8",  
                                crossDomain: true,
                                success: function(response){
                                    
                                    // response.Answer 에 챗봇의 응답메세지가 담겨 있다
                                    $chatbox = $("#chatbox");
                                    // 답변 출력
                        
                                    bottext ="<div class=chat-bot><div class=bot-profile><div class=img style=background: none;><img src=https://openclipart.org/image/800px/262355 alt=챗봇></div><div class=name>챗봇</div></div><div class=bot-talk><div class=txt><div>"+response.Answer+"</div></div><div class=time><div>오후5:10</div></div></div></div>";
                                    $chatbox.append(bottext);
                                    
                       
                                }
                   
                 });
                })
                 $("#1").click(function(){
                    console.log('didi')
                 });
                 $("#2").click(function(){
                    console.log('didi')
                 });
                 $("#3").click(function(){
                    console.log('didi')
                 });
                // $chatbox.attr('src', 'http://127.0.0.1:5000/chatbot/TEST')
            }
            
            else if(response.Intent =='상품'){
                if(response.Intent2='대출')
                        $show=$("#show")
                        $show.append(response.Intent)
            }


        }
    })
        // 스크롤 조정하기
    $("#wrap").animate({scrollTop: $("#wrap").prop('scrollHeight')});
    
    // 먼저 입력했던 내용은 지우기
    $("#chattext").val("");
    $("#chattext").focus();
    }
 // end 
</script>
<!-- <script src="{%static 'js/index.js'%}" type="text/javascript"></script> -->
{%endblock%}